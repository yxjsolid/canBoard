C51 COMPILER V7.50   CANPROXY                                                              09/03/2013 01:10:01 PAGE 1   


C51 COMPILER V7.50, COMPILATION OF MODULE CANPROXY
OBJECT MODULE PLACED IN canProxy.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE canProxy.C BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg51.h>
   2          #include <string.h>
   3          
   4          
   5          
   6          
   7          bit read_flag = 0;
   8          
   9          //===================================================================================
  10          //      工程名称：      CAN总线收发一体程序
  11          //      功能描述：      利用CAN总线实现双向can语音传输
  12          
  13          //  IDE环境：   KEILC （or later）
  14          //      程序设计：      曙光单片机科技淘宝店
  15          //        
  16          //      组成文件：      main.c, FUNCTION.h,CAN.H
  17          //                              
  18          //      硬件连接：  STC89C5X+SJA1000+CTM8251+AMBE1000   
  19          //
  20          //      维护记录：      2012-10-26      v1.0 
  21          //===================================================================================
  22          
  23          
  24          
  25          //向串口发送一个字符 
  26          void send_char_com(unsigned char ch)  
  27          {
  28   1          SBUF=ch;
  29   1          while(!TI);
  30   1          TI=0;
  31   1      }
  32          
  33          //向串口发送一个字符串，strlen为该字符串长度 
  34          void send_string_com(unsigned char *str,unsigned int strlen)
  35          {
  36   1          unsigned int k=0;
  37   1          do 
  38   1          {
  39   2              send_char_com(*(str + k));
  40   2              k++;
  41   2          } while(k < strlen);
  42   1      }
  43          
  44          //***************************************************
  45          
  46          //初始化cpu
  47          
  48          //**************************************************
  49          void Init_Cpu(void)                                  //单片机初始化,开放外部中断0
  50          {
  51   1              IE = 0;
  52   1              PX0=1;
  53   1              EX0=1;
  54   1              IT0=0;
  55   1              EA=0;
C51 COMPILER V7.50   CANPROXY                                                              09/03/2013 01:10:01 PAGE 2   

  56   1      }
  57          
  58          
  59          void init_serialcomm(void)
  60          {
  61   1          SCON  = 0x50;       //SCON: serail mode 1, 8-bit UART, enable ucvr
  62   1          TMOD &= 0x0f;
  63   1          TMOD |= 0x20;       //TMOD: timer 1, mode 2, 8-bit reload 
  64   1          PCON |= 0x80;       //SMOD=1; 
  65   1          //TH1   = 0xFA;       //Baud:9600  fosc=11.0592MHz 
  66   1          //TL1   = 0xFA;
  67   1      
  68   1      
  69   1              TH1   = 0xF4;       //Baud:4800  fosc=11.0592MHz 
  70   1          TL1   = 0xF4;
  71   1          IE   |= 0x90;       //Enable Serial Interrupt 
  72   1          TR1   = 1;          // timer 1 run 
  73   1          ET1  = 0;
  74   1          //EA = 1;
  75   1         // TI=1; 
  76   1      }
  77          
  78          
  79          
  80          //串口接收中断函数 
  81          void serial () interrupt 4 using 1 
  82          {
  83   1          if(RI)
  84   1          {
  85   2                      unsigned char ch;
  86   2              RI = 0;
  87   2              ch=SBUF;
  88   2                      read_flag=1;
  89   2          }
  90   1      }
  91          #if 1
  92          void  main()
  93          {
  94   1          init_serialcomm();  //初始化串口 
  95   1          read_flag=0;
  96   1          while(1)
  97   1          {
  98   2                if(read_flag)  //如果取数标志已置位，就将读到的数从串口发出 
  99   2                {
 100   3                     read_flag=0; //取数标志清0 
 101   3                     //ES = 0;
 102   3                                   send_char_com(0x00);
 103   3                                   send_char_com(0x01);
 104   3                                   send_char_com(0x02);
 105   3                                   send_char_com(0x03);
 106   3                                   send_char_com(0x04);
 107   3                                   send_char_com(0x05);
 108   3                                   send_char_com(0x06);
 109   3                                   send_char_com(0x08);
 110   3                                        //ES = 1;
 111   3       
 112   3                }
 113   2          }
 114   1      
 115   1      }
 116          
 117          #else
C51 COMPILER V7.50   CANPROXY                                                              09/03/2013 01:10:01 PAGE 3   

              
              /****************************************************
              **函数原型：   void main(void)
              **功    能：   主程序部分:
              **入口参数:    无 
              **返 回 值:     
              *****************************************************/
              
              void main(void)
              {  
                      IE = 0;
                      //Init_Cpu();  
                      init_serialcomm();     //初始化串口 
                      //timer0initial();       //定时器0初始化
                
              
              #if 0
                      ss=Sja_1000_Init();
                      if (ss!=0)             //初始化失败
                      //send_string_com("init fail!");**********************
                      send_char_com(0xBB);              //测试专用发送到串口看状态   
                      else
                      EA=1; //初始化成功，开总中断
              #endif
              
              //次标识位可以作为，串口接收完，置标志然后发送出去或者当作按键发送******
                      while(1) 
                      { 
                              if(read_flag)  //如果取数标志已置位，就将读到的数从串口发出 
                              {
                                      read_flag=0; //取数标志清0 
                                      //ES = 0;
                                      send_char_com(0x00);
                                      send_char_com(0x01);
                                      send_char_com(0x02);
                                      send_char_com(0x03);
                                      send_char_com(0x04);
                                      send_char_com(0x05);
                                      send_char_com(0x06);
                                      send_char_com(0x08);
                                      //ES = 1;
                              }
                      }   
              
              }
              
              #endif
 165          
 166          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    139    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
